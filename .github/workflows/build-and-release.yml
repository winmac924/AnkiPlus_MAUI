name: Build and Release AnkiPlus MAUI

on:
  push:
    tags:
      - 'v*'  # v1.0.0ã®ã‚ˆã†ãªã‚¿ã‚°ã§ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  build-windows:
    runs-on: windows-latest
    
    env:
      PROJECT_PATH: 'AnkiPlus_MAUI.csproj'
      
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: ðŸ” Extract Version from Tag
      id: get_version
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          $version = "${{ github.ref_name }}" -replace "^v", ""
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "TAG_NAME=${{ github.ref_name }}" >> $env:GITHUB_OUTPUT
        } else {
          $version = "1.0.0-dev"
          $tag = "v1.0.0-dev"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "TAG_NAME=$tag" >> $env:GITHUB_OUTPUT
        }
        echo "Building version: $version"
      shell: powershell
      
    - name: ðŸ› ï¸ Restore Dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}
      
    - name: ðŸ—ï¸ Build Application
      run: |
        dotnet build ${{ env.PROJECT_PATH }} -c Release -f net9.0-windows10.0.19041.0 --no-restore
        
    - name: ðŸ“¦ Publish MSIX Package
      run: |
        dotnet publish ${{ env.PROJECT_PATH }} -c Release -f net9.0-windows10.0.19041.0 -p:RuntimeIdentifierOverride=win10-x64 -p:WindowsPackageType=MSIX -p:WindowsAppSDKSelfContained=true -p:ApplicationDisplayVersion=${{ steps.get_version.outputs.VERSION }}
        
    - name: ðŸ” Find MSIX Files
      id: find_msix
      run: |
        $msixFiles = Get-ChildItem -Path "bin/Release/net9.0-windows10.0.19041.0/win10-x64/publish/" -Filter "*.msix" -Recurse
        if ($msixFiles.Count -gt 0) {
          $msixPath = $msixFiles[0].FullName
          $msixName = $msixFiles[0].Name
          echo "MSIX_PATH=$msixPath" >> $env:GITHUB_OUTPUT
          echo "MSIX_NAME=$msixName" >> $env:GITHUB_OUTPUT
          echo "Found MSIX: $msixPath"
        } else {
          echo "âŒ No MSIX files found!"
          exit 1
        }
      shell: powershell
      
    - name: ðŸ“ Create Release Notes
      id: release_notes
      run: |
        $releaseNotes = @"
        ## ðŸš€ AnkiPlus MAUI ${{ steps.get_version.outputs.VERSION }}
        
        ### ðŸ“¥ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
        1. ä¸‹è¨˜ã® ```.msix``` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        2. ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        3. å¿…è¦ã«å¿œã˜ã¦ã€Œä¸æ˜Žãªç™ºè¡Œå…ƒã€ã®è­¦å‘Šã‚’è¨±å¯
        
        ### ðŸ”„ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
        - æ—¢å­˜ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å ´åˆã€è‡ªå‹•çš„ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã‚Œã¾ã™
        - ã‚¢ãƒ—ãƒªå†…è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ©Ÿèƒ½ã«ã‚ˆã‚Šã€æ¬¡å›žã‹ã‚‰æ‰‹å‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸è¦
        
        ### ðŸ“‹ å¤‰æ›´å†…å®¹
        - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã®æ”¹å–„
        - ãƒã‚°ä¿®æ­£
        - UI/UX ã®å‘ä¸Š
        
        ### ðŸ”§ ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶
        - Windows 10 (ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 1809 ä»¥é™) ã¾ãŸã¯ Windows 11
        - .NET 9.0 Runtime (è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)
        
        ---
        **ðŸ“– è©³ç´°ãªå¤‰æ›´å±¥æ­´ã¯ [Commits](${{ github.server_url }}/${{ github.repository }}/commits/${{ steps.get_version.outputs.TAG_NAME }}) ã‚’ã”ç¢ºèªãã ã•ã„ã€‚**
        "@
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã—ã¦GitHub Actionsã§åˆ©ç”¨
        $releaseNotes | Out-File -FilePath "release-notes.md" -Encoding UTF8
        echo "RELEASE_NOTES_FILE=release-notes.md" >> $env:GITHUB_OUTPUT
      shell: powershell
    
    - name: ðŸ·ï¸ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.TAG_NAME }}
        name: AnkiPlus MAUI ${{ steps.get_version.outputs.VERSION }}
        body_path: ${{ steps.release_notes.outputs.RELEASE_NOTES_FILE }}
        files: |
          ${{ steps.find_msix.outputs.MSIX_PATH }}
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.VERSION, 'dev') || contains(steps.get_version.outputs.VERSION, 'alpha') || contains(steps.get_version.outputs.VERSION, 'beta') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: âœ… Build Summary
      run: |
        echo "## ðŸŽ‰ ãƒ“ãƒ«ãƒ‰å®Œäº†!" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ã‚¿ã‚°**: ${{ steps.get_version.outputs.TAG_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **MSIXãƒ•ã‚¡ã‚¤ãƒ«**: ${{ steps.find_msix.outputs.MSIX_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒªãƒªãƒ¼ã‚¹URL**: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.TAG_NAME }}" >> $GITHUB_STEP_SUMMARY 