name: Build and Release AnkiPlus MAUI

on:
  push:
    tags:
      - 'v*'  # v1.0.0ã®ã‚ˆã†ãªã‚¿ã‚°ã§ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

# GitHub Actionsã®æ¨©é™è¨­å®š
permissions:
  contents: write
  packages: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    env:
      PROJECT_PATH: 'AnkiPlus_MAUI.csproj'
      
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: ðŸ” Extract Version from Tag
      id: get_version
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          $version = "${{ github.ref_name }}" -replace "^v", ""
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "TAG_NAME=${{ github.ref_name }}" >> $env:GITHUB_OUTPUT
        } else {
          $version = "1.0.0-dev"
          $tag = "v1.0.0-dev"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "TAG_NAME=$tag" >> $env:GITHUB_OUTPUT
        }
        echo "Building version: $version"
      shell: powershell
      
    - name: ðŸ› ï¸ Restore Dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}
      
    - name: ðŸ—ï¸ Build Application
      run: |
        dotnet build ${{ env.PROJECT_PATH }} -c Release -f net9.0-windows10.0.19041.0 --no-restore
        
    - name: ðŸ“¦ Publish Executable
      run: |
        dotnet publish ${{ env.PROJECT_PATH }} -c Release -f net9.0-windows10.0.19041.0 -r win-x64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -p:ApplicationDisplayVersion=${{ steps.get_version.outputs.VERSION }}
        
    - name: ðŸ” Debug List Files
      run: |
        echo "=== Listing all files in bin directory ==="
        Get-ChildItem -Path "bin" -Recurse | Select-Object FullName, Length
        echo "=== End of file listing ==="
      shell: powershell
      
    - name: ðŸ” Find Executable Files
      id: find_exe
      run: |
        # è¤‡æ•°ã®ãƒ‘ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦ã™
        $searchPaths = @(
          "bin/Release/net9.0-windows10.0.19041.0/win-x64/publish/",
          "bin\Release\net9.0-windows10.0.19041.0\win-x64\publish\",
          "bin/Release/net9.0-windows10.0.19041.0/win-x64/",
          "bin\Release\net9.0-windows10.0.19041.0\win-x64\"
        )
        
        $exeFound = $false
        foreach ($searchPath in $searchPaths) {
          if (Test-Path $searchPath) {
            echo "Searching in: $searchPath"
            $exeFiles = Get-ChildItem -Path $searchPath -Filter "*.exe" -Recurse -ErrorAction SilentlyContinue
            if ($exeFiles.Count -gt 0) {
              $exePath = $exeFiles[0].FullName
              $exeName = $exeFiles[0].Name
              
              # ç›¸å¯¾ãƒ‘ã‚¹ã«å¤‰æ›
              $relativePath = $exePath -replace [regex]::Escape($PWD.Path + "\"), ""
              $relativePath = $relativePath -replace "\\", "/"
              
              echo "EXE_PATH=$relativePath" >> $env:GITHUB_OUTPUT
              echo "EXE_NAME=$exeName" >> $env:GITHUB_OUTPUT
              echo "Found EXE: $exePath"
              echo "Relative path: $relativePath"
              
              # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ç¢ºèª
              $fileSize = [math]::Round((Get-Item $exePath).Length / 1MB, 2)
              echo "EXE_SIZE=$fileSize MB" >> $env:GITHUB_OUTPUT
              echo "File size: $fileSize MB"
              
              $exeFound = $true
              break
            }
          }
        }
        
        if (-not $exeFound) {
          echo "âŒ No EXE files found in any search path!"
          echo "Available files:"
          Get-ChildItem -Path "bin" -Recurse -Filter "*.exe" | Select-Object FullName
          exit 1
        }
      shell: powershell
      
    - name: ðŸ“ Prepare Release Info
      id: release_info
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $fileSize = "${{ steps.find_exe.outputs.EXE_SIZE }}"
        
        # GitHub Outputã«å„è¦ç´ ã‚’è¨­å®š
        echo "VERSION_INFO=$version" >> $env:GITHUB_OUTPUT
        echo "FILE_SIZE_INFO=$fileSize" >> $env:GITHUB_OUTPUT
      shell: powershell
    
    - name: ðŸ·ï¸ Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_version.outputs.TAG_NAME }}
        name: AnkiPlus MAUI ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## ðŸš€ AnkiPlus MAUI ${{ steps.release_info.outputs.VERSION_INFO }}
          
          ### ðŸ“¥ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
          1. ä¸‹è¨˜ã® `.exe` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦å®Ÿè¡Œ
          3. å¿…è¦ã«å¿œã˜ã¦ã€Œä¸æ˜Žãªç™ºè¡Œå…ƒã€ã®è­¦å‘Šã‚’è¨±å¯
          4. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ã§ç›´æŽ¥å®Ÿè¡Œå¯èƒ½ï¼ˆãƒãƒ¼ã‚¿ãƒ–ãƒ«ç‰ˆï¼‰
          
          ### ðŸ”„ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
          - ã‚¢ãƒ—ãƒªå†…è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ©Ÿèƒ½ã«ã‚ˆã‚Šã€æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè‡ªå‹•æ¤œå‡ºã•ã‚Œã¾ã™
          - æ‰‹å‹•ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãæ›ãˆã¦ãã ã•ã„
          
          ### ðŸ“‹ å¤‰æ›´å†…å®¹
          - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã®æ”¹å–„
          - ãƒã‚°ä¿®æ­£
          - UI/UX ã®å‘ä¸Š
          
          ### ðŸ”§ ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶
          - Windows 10 (ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 1809 ä»¥é™) ã¾ãŸã¯ Windows 11
          - .NET Runtimeä¸è¦ï¼ˆè‡ªå·±å®Œçµåž‹å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
          - ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ç´„ ${{ steps.release_info.outputs.FILE_SIZE_INFO }}
          
          ---
          **ðŸ“– è©³ç´°ãªå¤‰æ›´å±¥æ­´ã¯ [Commits](${{ github.server_url }}/${{ github.repository }}/commits/${{ steps.get_version.outputs.TAG_NAME }}) ã‚’ã”ç¢ºèªãã ã•ã„ã€‚**
        files: ${{ steps.find_exe.outputs.EXE_PATH }}
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.VERSION, 'dev') || contains(steps.get_version.outputs.VERSION, 'alpha') || contains(steps.get_version.outputs.VERSION, 'beta') }}
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: âœ… Build Summary
      run: |
        echo "## ðŸŽ‰ ãƒ“ãƒ«ãƒ‰å®Œäº†!" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ã‚¿ã‚°**: ${{ steps.get_version.outputs.TAG_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«**: ${{ steps.find_exe.outputs.EXE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: ${{ steps.find_exe.outputs.EXE_SIZE }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒªãƒªãƒ¼ã‚¹URL**: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.TAG_NAME }}" >> $GITHUB_STEP_SUMMARY 